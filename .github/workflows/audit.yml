name: Weekly Code Audit

on:
  schedule:
    - cron: '0 9 * * 1' # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹æ‰§è¡Œ (UTCæ—¶é—´)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  code-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºåˆ†æ

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          echo "å®‰è£…é¡¹ç›®ä¾èµ–..."
          npm install || pnpm install || yarn install

      - name: Install Gemini CLI
        run: |
          echo "å®‰è£… Gemini CLI..."
          npm install -g @google/gemini-cli
          echo "éªŒè¯å®‰è£…..."
          gemini --version || echo "Gemini CLI ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          echo "æµ‹è¯• API è¿æ¥..."
          echo "Hello" | timeout 30s gemini || echo "API è¿æ¥æµ‹è¯•å¤±è´¥"

      - name: Create audit output directories
        run: |
          mkdir -p .audit-reports
          mkdir -p public/data

      - name: Collect Code Statistics
        run: |
          echo "=== æ”¶é›†ä»£ç ç»Ÿè®¡ä¿¡æ¯ ==="
          
          # ç»Ÿè®¡ä»£ç è¡Œæ•°
          echo "ä»£ç è¡Œæ•°ç»Ÿè®¡:" > .audit-reports/code-stats.txt
          find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | xargs wc -l >> .audit-reports/code-stats.txt
          
          # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
          echo "" >> .audit-reports/code-stats.txt
          echo "æ–‡ä»¶ç±»å‹ç»Ÿè®¡:" >> .audit-reports/code-stats.txt
          find src -type f | grep -E '\.(ts|tsx|js|jsx)$' | sed 's/.*\.//' | sort | uniq -c >> .audit-reports/code-stats.txt
          
          # Git æäº¤ç»Ÿè®¡
          echo "" >> .audit-reports/code-stats.txt
          echo "æœ€è¿‘ä¸€å‘¨æäº¤ç»Ÿè®¡:" >> .audit-reports/code-stats.txt
          git log --since="1 week ago" --oneline >> .audit-reports/code-stats.txt

      - name: Run ESLint Analysis
        run: |
          echo "=== è¿è¡Œ ESLint ä»£ç è´¨é‡æ£€æŸ¥ ==="
          npx eslint src --ext .ts,.tsx,.js,.jsx --format json > .audit-reports/eslint-report.json || true
          npx eslint src --ext .ts,.tsx,.js,.jsx > .audit-reports/eslint-report.txt || true

      - name: Run TypeScript Compiler Check
        run: |
          echo "=== è¿è¡Œ TypeScript ç¼–è¯‘æ£€æŸ¥ ==="
          npx tsc --noEmit --pretty > .audit-reports/typescript-check.txt 2>&1 || true

      - name: Security Audit
        run: |
          echo "=== è¿è¡Œå®‰å…¨å®¡è®¡ ==="
          npm audit --json > .audit-reports/npm-audit.json 2>&1 || true
          npm audit > .audit-reports/npm-audit.txt 2>&1 || true

      - name: Check for TODO and FIXME
        run: |
          echo "=== æ£€æŸ¥ TODO å’Œ FIXME æ ‡è®° ==="
          echo "TODO å’Œ FIXME åˆ—è¡¨:" > .audit-reports/todos.txt
          grep -r -n "TODO\|FIXME\|XXX\|HACK" src || echo "æœªå‘ç° TODO/FIXME æ ‡è®°" >> .audit-reports/todos.txt

      - name: Generate AI Code Audit Report
        run: |
          echo "=== ä½¿ç”¨ AI ç”Ÿæˆä»£ç å®¡è®¡æŠ¥å‘Š ==="
          
          TIMESTAMP=$(date +%s)
          CURRENT_DATE=$(date '+%Y-%m-%d')
          
          # å‡†å¤‡å®¡è®¡æ•°æ®
          CODE_STATS=$(cat .audit-reports/code-stats.txt 2>/dev/null || echo "æ— æ³•è·å–ä»£ç ç»Ÿè®¡")
          ESLINT_ISSUES=$(cat .audit-reports/eslint-report.txt 2>/dev/null || echo "æ—  ESLint é—®é¢˜")
          TS_ISSUES=$(cat .audit-reports/typescript-check.txt 2>/dev/null || echo "æ—  TypeScript é—®é¢˜")
          SECURITY_ISSUES=$(cat .audit-reports/npm-audit.txt 2>/dev/null || echo "æ— å®‰å…¨é—®é¢˜")
          TODO_LIST=$(cat .audit-reports/todos.txt 2>/dev/null || echo "æ—  TODO æ ‡è®°")
          
          # è·å–æœ€è¿‘çš„ä»£ç å˜æ›´
          RECENT_CHANGES=$(git log --since="1 week ago" --pretty=format:"%h - %s (%an, %ar)" | head -10 || echo "æ— æœ€è¿‘å˜æ›´")
          
          PROMPT="è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„ä»£ç å®¡è®¡æŠ¥å‘Šï¼Œæ ¼å¼ä¸º Markdownã€‚æŠ¥å‘Šæ—¥æœŸï¼š$CURRENT_DATE

          è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯è¿›è¡Œåˆ†æï¼š

          ## ä»£ç ç»Ÿè®¡ä¿¡æ¯
          \`\`\`
          $CODE_STATS
          \`\`\`

          ## ESLint æ£€æŸ¥ç»“æœ
          \`\`\`
          $ESLINT_ISSUES
          \`\`\`

          ## TypeScript ç¼–è¯‘æ£€æŸ¥
          \`\`\`
          $TS_ISSUES
          \`\`\`

          ## å®‰å…¨å®¡è®¡ç»“æœ
          \`\`\`
          $SECURITY_ISSUES
          \`\`\`

          ## TODO/FIXME æ ‡è®°
          \`\`\`
          $TODO_LIST
          \`\`\`

          ## æœ€è¿‘ä»£ç å˜æ›´
          \`\`\`
          $RECENT_CHANGES
          \`\`\`

          è¯·ç”Ÿæˆä¸€ä¸ªåŒ…å«ä»¥ä¸‹éƒ¨åˆ†çš„ Markdown æŠ¥å‘Šï¼š
          1. æ‰§è¡Œæ‘˜è¦
          2. ä»£ç è´¨é‡è¯„ä¼°
          3. å®‰å…¨é—®é¢˜åˆ†æ
          4. æ€§èƒ½å»ºè®®
          5. æŠ€æœ¯å€ºåŠ¡è¯†åˆ«
          6. æ”¹è¿›å»ºè®®
          7. ä¼˜å…ˆçº§æ’åºçš„è¡ŒåŠ¨é¡¹

          è¯·ç¡®ä¿æŠ¥å‘Šä¸“ä¸šã€è¯¦ç»†ä¸”å…·æœ‰å¯æ“ä½œæ€§ã€‚æ—¶é—´æˆ³ï¼š$TIMESTAMP"

                    # ç”Ÿæˆ AI å®¡è®¡æŠ¥å‘Š
                    MAX_RETRIES=3
                    RETRY_COUNT=0
                    SUCCESS=false
                    
                    while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
                      echo "å°è¯•ç¬¬ $((RETRY_COUNT + 1)) æ¬¡ç”Ÿæˆå®¡è®¡æŠ¥å‘Š..."
                      
                      timeout 180s bash -c "echo '$PROMPT' | gemini" > /tmp/audit_output.txt 2>&1
                      EXIT_CODE=$?
                      
                      OUTPUT=$(cat /tmp/audit_output.txt 2>/dev/null || echo "")
                      
                      if [ $EXIT_CODE -eq 0 ] && [ ${#OUTPUT} -gt 1000 ]; then
                        echo "âœ… AI å®¡è®¡æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
                        
                        # æ¸…ç†è¾“å‡ºå¹¶ä¿å­˜
                        echo "$OUTPUT" | sed '/^```markdown/d' | sed '/^```$/d' | sed '/^```/d' > .audit-reports/ai-audit-report.md
                        
                        # æ·»åŠ æŠ¥å‘Šå¤´éƒ¨ä¿¡æ¯å¹¶ä¿å­˜åˆ° public/data
                        cat > public/data/weekly-audit-report.md << EOF
          # ä»£ç å®¡è®¡æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **å®¡è®¡å‘¨æœŸ**: $(date -d '7 days ago' '+%Y-%m-%d') è‡³ $(date '+%Y-%m-%d')  
          **é¡¹ç›®**: $(basename $(pwd))  

          ---

          EOF
                        cat .audit-reports/ai-audit-report.md >> public/data/weekly-audit-report.md
              
              # åŒæ—¶ä¿ç•™ä¸€ä»½åœ¨ .audit-reports ç›®å½•ç”¨äºå†…éƒ¨å¤„ç†
              cp public/data/weekly-audit-report.md .audit-reports/weekly-audit-report.md
              
              SUCCESS=true
            else
              echo "âŒ AI å®¡è®¡æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((30 + RETRY_COUNT * 30))
                echo "ç­‰å¾… $WAIT_TIME ç§’åé‡è¯•..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # å¦‚æœ AI ç”Ÿæˆå¤±è´¥ï¼Œåˆ›å»ºåŸºç¡€æŠ¥å‘Š
          if [ "$SUCCESS" = "false" ]; then
            echo "âš ï¸ AI ç”Ÿæˆå¤±è´¥ï¼Œåˆ›å»ºåŸºç¡€å®¡è®¡æŠ¥å‘Š..."
            cat > public/data/weekly-audit-report.md << EOF
          # ä»£ç å®¡è®¡æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **å®¡è®¡å‘¨æœŸ**: $(date -d '7 days ago' '+%Y-%m-%d') è‡³ $(date '+%Y-%m-%d')  
          **é¡¹ç›®**: $(basename $(pwd))  
          **çŠ¶æ€**: åŸºç¡€æŠ¥å‘Š (AI åˆ†ææš‚æ—¶ä¸å¯ç”¨)

          ## æ‰§è¡Œæ‘˜è¦

          æœ¬å‘¨ä»£ç å®¡è®¡å·²å®ŒæˆåŸºç¡€æ£€æŸ¥ï¼Œè¯¦ç»†åˆ†æè¯·æŸ¥çœ‹å„é¡¹æ£€æŸ¥ç»“æœã€‚

          ## ä»£ç ç»Ÿè®¡

          \`\`\`
          $CODE_STATS
          \`\`\`

          ## ESLint æ£€æŸ¥ç»“æœ

          \`\`\`
          $ESLINT_ISSUES
          \`\`\`

          ## TypeScript æ£€æŸ¥ç»“æœ

          \`\`\`
          $TS_ISSUES
          \`\`\`

          ## å®‰å…¨å®¡è®¡ç»“æœ

          \`\`\`
          $SECURITY_ISSUES
          \`\`\`

          ## TODO/FIXME æ ‡è®°

          \`\`\`
          $TODO_LIST
          \`\`\`

          ## æœ€è¿‘å˜æ›´

          \`\`\`
          $RECENT_CHANGES
          \`\`\`

          ---
          *æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ*
          EOF
            # åŒæ—¶ä¿ç•™ä¸€ä»½åœ¨ .audit-reports ç›®å½•ç”¨äºå†…éƒ¨å¤„ç†
            cp public/data/weekly-audit-report.md .audit-reports/weekly-audit-report.md
          fi
          
          rm -f /tmp/audit_output.txt
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Create GitHub Issue for Critical Issues
        run: |
          echo "=== æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»º GitHub Issue ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é—®é¢˜
          CRITICAL_ISSUES=false
          
          # æ£€æŸ¥é«˜å±å®‰å…¨æ¼æ´
          if grep -q "high\|critical" .audit-reports/npm-audit.txt 2>/dev/null; then
            CRITICAL_ISSUES=true
            echo "å‘ç°é«˜å±å®‰å…¨æ¼æ´"
          fi
          
          # æ£€æŸ¥ TypeScript é”™è¯¯
          if grep -q "error" .audit-reports/typescript-check.txt 2>/dev/null; then
            CRITICAL_ISSUES=true
            echo "å‘ç° TypeScript ç¼–è¯‘é”™è¯¯"
          fi
          
          if [ "$CRITICAL_ISSUES" = "true" ]; then
            echo "NEED_ISSUE=true" >> $GITHUB_ENV
            echo "å‘ç°ä¸¥é‡é—®é¢˜ï¼Œå°†åˆ›å»º GitHub Issue"
          else
            echo "NEED_ISSUE=false" >> $GITHUB_ENV
            echo "æœªå‘ç°ä¸¥é‡é—®é¢˜"
          fi

      - name: Create Issue for Critical Problems
        if: env.NEED_ISSUE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditReport = fs.readFileSync('public/data/weekly-audit-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ ä»£ç å®¡è®¡å‘ç°ä¸¥é‡é—®é¢˜ - ${new Date().toISOString().split('T')[0]}`,
              body: `## è‡ªåŠ¨ä»£ç å®¡è®¡è­¦æŠ¥

            æœ¬æ¬¡ä»£ç å®¡è®¡å‘ç°äº†éœ€è¦ç«‹å³å…³æ³¨çš„ä¸¥é‡é—®é¢˜ã€‚

            ### å®¡è®¡æŠ¥å‘Šæ‘˜è¦

            ${auditReport.substring(0, 2000)}...

            [æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](public/data/weekly-audit-report.md)

            ### å»ºè®®è¡ŒåŠ¨

            1. ç«‹å³æ£€æŸ¥å®‰å…¨æ¼æ´
            2. ä¿®å¤ TypeScript ç¼–è¯‘é”™è¯¯
            3. å®¡æŸ¥ä»£ç è´¨é‡é—®é¢˜

            ---
            *æ­¤ Issue ç”±è‡ªåŠ¨åŒ–ä»£ç å®¡è®¡ç³»ç»Ÿåˆ›å»º*`,
                          labels: ['audit', 'critical', 'automated']
                        });



      - name: Commit Audit Reports
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“Š Weekly Code Audit Report - $(date '+%Y-%m-%d')"
          file_pattern: "public/data/weekly-audit-report.md"
          commit_user_name: "Code Audit Bot"
          commit_user_email: "code-audit-bot@users.noreply.github.com"

      - name: Summary
        run: |
          echo "=== å®¡è®¡å®Œæˆæ‘˜è¦ ==="
          echo "âœ… ä»£ç ç»Ÿè®¡åˆ†æå®Œæˆ"
          echo "âœ… ESLint è´¨é‡æ£€æŸ¥å®Œæˆ"
          echo "âœ… TypeScript ç¼–è¯‘æ£€æŸ¥å®Œæˆ"
          echo "âœ… å®‰å…¨æ¼æ´æ‰«æå®Œæˆ"
          echo "âœ… TODO/FIXME æ ‡è®°æ£€æŸ¥å®Œæˆ"
          echo "âœ… AI å®¡è®¡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
          echo ""
          echo "ğŸ“Š æŠ¥å‘Šæ–‡ä»¶:"
          ls -la .audit-reports/
          echo ""
          echo "ğŸ” æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: public/data/weekly-audit-report.md"