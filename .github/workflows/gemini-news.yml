name: Generate Daily News

on:
  schedule:
    - cron: '0 22 * * *' # Runs at 22:00 UTC, which is 6:00 AM Beijing time
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-news:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # è®¾ç½®æ•´ä¸ª job çš„è¶…æ—¶æ—¶é—´ä¸º 5 åˆ†é’Ÿ
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Gemini CLI
        run: |
          echo "å®‰è£… Gemini CLI..."
          npm install -g @google/gemini-cli
          echo "éªŒè¯å®‰è£…..."
          gemini --version || echo "Gemini CLI ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          echo "æµ‹è¯• API è¿æ¥..."
          echo "Hello" | timeout 30s gemini || echo "API è¿æ¥æµ‹è¯•å¤±è´¥"
      - name: Create output directory
        run: mkdir -p public/data

      - name: Check API availability
        run: |
          echo "=== æ£€æŸ¥ Gemini API å¯ç”¨æ€§ ==="
          
          # ç®€å•çš„ API å¥åº·æ£€æŸ¥
          echo "æµ‹è¯•åŸºæœ¬ API è¿æ¥..."
          if timeout 30s bash -c "echo 'test' | gemini" > /tmp/api_test.txt 2>&1; then
            echo "âœ… API åŸºæœ¬è¿æ¥æ­£å¸¸"
            cat /tmp/api_test.txt | head -5
          else
            echo "âš ï¸  API è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ç”Ÿæˆ"
            cat /tmp/api_test.txt | head -10
          fi
          
          rm -f /tmp/api_test.txt

      - name: Generate and save daily news
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆ24å°æ—¶å†…æ–°é—» ==="
          
          CURRENT_DATE=$(date '+%Yå¹´%mæœˆ%dæ—¥')
          CURRENT_TIME=$(date '+%H:%M UTC')
          
          echo "å½“å‰æ—¥æœŸ: $CURRENT_DATE"
          echo "å½“å‰æ—¶é—´: $CURRENT_TIME"
          
          # ç®€åŒ–çš„ promptï¼Œå‡å°‘ç”Ÿæˆæ—¶é—´
          PROMPT="Please provide TOP10 global breaking news from the past 24 hours, sourced exclusively from English mainstream media.

          Please return strictly in the following format:

          # Global Breaking News TOP10 / å…¨çƒçƒ­ç‚¹æ–°é—»TOP10

          **Date**: $CURRENT_DATE  
          **Update Time**: $CURRENT_TIME  
          **Data Source**: English Mainstream Media / è‹±æ–‡ä¸»æµåª’ä½“ç»¼åˆ  

          ---

          ### 1. **[English Title]** / **[ä¸­æ–‡æ ‡é¢˜]**
          - **Keywords**: [English Keywords] / [ä¸­æ–‡å…³é”®è¯]
          - **Content**: [English Summary] / [ä¸­æ–‡æ‘˜è¦]
          - **Published**: [Date]
          - **Source**: [Media Name]

          ---

          (Continue generating news 2-10 in the same format)

          ---

          *This news summary is generated by AI for reference only. / æœ¬æ–°é—»æ‘˜è¦ç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚*

          Requirements:
          1. All news must be from the past 24 hours
          2. Sources limited to English mainstream media only
          3. Each news summary no more than 2 sentences
          4. Ranked by importance
          5. Focus on politics, economics, international relations"
          
          # æ”¹è¿›çš„é‡è¯•æœºåˆ¶ - å¢åŠ è¶…æ—¶æ—¶é—´å’Œé‡è¯•æ¬¡æ•°
          MAX_RETRIES=2
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "å°è¯•ç¬¬ $((RETRY_COUNT + 1)) æ¬¡ç”Ÿæˆ..."
            
            # å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 300 ç§’ (5åˆ†é’Ÿ)
            timeout 300s bash -c "echo '$PROMPT' | gemini" > /tmp/gemini_output.txt 2>&1
            EXIT_CODE=$?
            
            # è¯»å–è¾“å‡ºå†…å®¹
            OUTPUT=$(cat /tmp/gemini_output.txt 2>/dev/null || echo "")
            
            echo "API è°ƒç”¨é€€å‡ºç : $EXIT_CODE"
            echo "è¾“å‡ºé•¿åº¦: ${#OUTPUT} å­—ç¬¦"
            
            # æ£€æŸ¥å„ç§é”™è¯¯æƒ…å†µ
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âŒ API è°ƒç”¨è¶…æ—¶ (300ç§’)"
              echo "è¾“å‡ºå†…å®¹é¢„è§ˆ:"
              echo "$OUTPUT" | head -5
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ API è°ƒç”¨å¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
              echo "é”™è¯¯è¾“å‡º:"
              echo "$OUTPUT" | head -10
            elif [ -z "$OUTPUT" ]; then
              echo "âŒ API è¿”å›ç©ºå†…å®¹"
            elif echo "$OUTPUT" | grep -qi "error\|failed\|exception\|apiError\|status.*500\|internal.*error\|unavailable\|timeout"; then
              echo "âŒ API è¿”å›é”™è¯¯ä¿¡æ¯:"
              echo "$OUTPUT" | head -10
            elif echo "$OUTPUT" | grep -q "I'm ready. What would you like me to do?"; then
              echo "âŒ API è¿”å›é»˜è®¤æç¤ºä¿¡æ¯ï¼Œæœªæ­£ç¡®å¤„ç†è¯·æ±‚"
            else
              # å¤„ç†æˆåŠŸçš„è¾“å‡º
              echo "âœ… API è°ƒç”¨æˆåŠŸï¼Œå¤„ç†è¾“å‡ºå†…å®¹..."
              
              # æ¸…ç†è¾“å‡ºå¹¶ä¿å­˜åˆ°æ–‡ä»¶
              echo "$OUTPUT" | sed '/^```markdown/d' | sed '/^```$/d' | sed '/^```/d' > public/data/daily-news.md
              
              # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
              if [ -s "public/data/daily-news.md" ]; then
                FILE_SIZE=$(wc -c < public/data/daily-news.md)
                LINE_COUNT=$(wc -l < public/data/daily-news.md)
                
                echo "ç”Ÿæˆæ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
                echo "ç”Ÿæˆæ–‡ä»¶è¡Œæ•°: $LINE_COUNT è¡Œ"
                
                # è°ƒæ•´éªŒè¯æ ‡å‡†ï¼Œé€‚åº” TOP10 æ ¼å¼
                if [ $FILE_SIZE -gt 1000 ] && [ $LINE_COUNT -gt 30 ]; then
                  if grep -q "# å…¨çƒçƒ­ç‚¹æ–°é—»TOP10" public/data/daily-news.md && grep -q "### 1\." public/data/daily-news.md; then
                    echo "âœ… å†…å®¹ç”ŸæˆæˆåŠŸï¼ŒåŒ…å«é¢„æœŸç»“æ„"
                    SUCCESS=true
                    break
                  else
                    echo "âŒ ç”Ÿæˆçš„å†…å®¹ç¼ºå°‘é¢„æœŸç»“æ„"
                    echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
                    head -10 public/data/daily-news.md
                  fi
                else
                  echo "âŒ ç”Ÿæˆçš„æ–‡ä»¶å¤ªå°æˆ–è¡Œæ•°ä¸è¶³"
                  echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
                  head -10 public/data/daily-news.md
                fi
              else
                echo "âŒ ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
              fi
            fi
            
            # å¦‚æœæœªæˆåŠŸï¼Œå‡†å¤‡é‡è¯•
            if [ "$SUCCESS" = "false" ]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                # æŒ‡æ•°é€€é¿ç­–ç•¥ - å‡å°‘ç­‰å¾…æ—¶é—´
                WAIT_TIME=$((20 + RETRY_COUNT * 20))
                echo "ç­‰å¾… $WAIT_TIME ç§’åé‡è¯•..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/gemini_output.txt
          
          # æœ€ç»ˆæ£€æŸ¥
          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ($MAX_RETRIES)ï¼ŒAPI æŒç»­å¤±è´¥"
            echo "ğŸ”„ åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Š..."
            
            # åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Šè€Œä¸æ˜¯è®©å·¥ä½œæµå¤±è´¥
            cat > public/data/daily-news.md << EOF
          # æ–°é—»æœåŠ¡çŠ¶æ€æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **çŠ¶æ€**: API æœåŠ¡æš‚æ—¶ä¸å¯ç”¨  

          ## æœåŠ¡ä¿¡æ¯

          Gemini API å½“å‰é‡åˆ°è¶…æ—¶æˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè¿™é€šå¸¸æ˜¯ä¸´æ—¶æ€§é—®é¢˜ã€‚

          ## é”™è¯¯è¯¦æƒ…

          \`\`\`
          é‡è¯•æ¬¡æ•°: $MAX_RETRIES
          æœ€åé”™è¯¯: API è¶…æ—¶æˆ–æœåŠ¡å™¨é”™è¯¯
          è¶…æ—¶è®¾ç½®: 300ç§’
          \`\`\`

          ## ä¸‹æ¬¡ç”Ÿæˆ

          ç³»ç»Ÿå°†åœ¨ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡ä¸­è‡ªåŠ¨é‡è¯•ç”Ÿæˆ24å°æ—¶å†…æ–°é—»å†…å®¹ã€‚

          ---
          *æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ*
          EOF
            
            echo "âœ… å·²åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Š"
            # ä¸è¦ exit 1ï¼Œè®©å·¥ä½œæµç»§ç»­æ‰§è¡Œä»¥æäº¤çŠ¶æ€æŠ¥å‘Š
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Check if content has changed
        run: |
          echo "=== Content Change Detection ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰æ–‡ä»¶
          if [ -f "public/data/daily-news.md" ]; then
            # ä¿å­˜æ–°ç”Ÿæˆçš„æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
            cp public/data/daily-news.md /tmp/new_daily_news.md
            
            # è·å–å½“å‰ä»“åº“ä¸­çš„æ–‡ä»¶
            if git show HEAD:public/data/daily-news.md > /tmp/current_daily_news.md 2>/dev/null; then
              echo "âœ… æˆåŠŸè·å–å½“å‰ä»“åº“æ–‡ä»¶"
            else
              echo "âš ï¸  æ— æ³•è·å–å½“å‰ä»“åº“æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯æ–°æ–‡ä»¶"
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
              exit 0
            fi
            
            # è®¡ç®—å“ˆå¸Œå€¼
            NEW_HASH=$(sha256sum /tmp/new_daily_news.md | cut -d' ' -f1)
            CURRENT_HASH=$(sha256sum /tmp/current_daily_news.md | cut -d' ' -f1)
            
            echo "æ–°ç”Ÿæˆæ–‡ä»¶å“ˆå¸Œ: $NEW_HASH"
            echo "å½“å‰æ–‡ä»¶å“ˆå¸Œ: $CURRENT_HASH"
            echo "æ–°æ–‡ä»¶å¤§å°: $(wc -c < /tmp/new_daily_news.md) bytes"
            echo "å½“å‰æ–‡ä»¶å¤§å°: $(wc -c < /tmp/current_daily_news.md) bytes"
            echo "æ–°æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/new_daily_news.md) lines"
            echo "å½“å‰æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/current_daily_news.md) lines"
            
            # æ˜¾ç¤ºå†…å®¹å·®å¼‚
            echo ""
            echo "=== å†…å®¹å·®å¼‚æ¯”è¾ƒ ==="
            if diff -q /tmp/new_daily_news.md /tmp/current_daily_news.md > /dev/null; then
              echo "âŒ æ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒï¼Œè·³è¿‡æäº¤"
              echo "CONTENT_CHANGED=false" >> $GITHUB_ENV
            else
              echo "âœ… æ–‡ä»¶å†…å®¹æœ‰å·®å¼‚ï¼Œç»§ç»­æäº¤"
              echo "å·®å¼‚è¯¦æƒ…ï¼š"
              diff -u /tmp/current_daily_news.md /tmp/new_daily_news.md || true
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/new_daily_news.md /tmp/current_daily_news.md
          else
            echo "âœ… æ–°æ–‡ä»¶ï¼Œç»§ç»­æäº¤"
            echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Verify file content
        run: |
          echo "=== æ–‡ä»¶å†…å®¹éªŒè¯ ==="
          if [ -f "public/data/daily-news.md" ]; then
            FILE_SIZE=$(wc -c < public/data/daily-news.md)
            LINE_COUNT=$(wc -l < public/data/daily-news.md)
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            echo "æ–‡ä»¶è¡Œæ•°: $LINE_COUNT è¡Œ"
            echo ""
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ (å‰20è¡Œ):"
            head -20 public/data/daily-news.md
            echo ""
            if [ $LINE_COUNT -gt 20 ]; then
              echo "... (å…± $LINE_COUNT è¡Œï¼Œæ˜¾ç¤ºå‰20è¡Œ)"
            fi
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: public/data/daily-news.md"
          fi

      - name: Show commit status
        run: |
          if [ "$CONTENT_CHANGED" = "true" ]; then
            echo "âœ… å‡†å¤‡æäº¤æ›´æ”¹..."
          else
            echo "â­ï¸  è·³è¿‡æäº¤ - å†…å®¹æ²¡æœ‰å˜åŒ–"
          fi

      - name: Commit and push the generated file
        if: env.CONTENT_CHANGED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI Generate Daily News"
          file_pattern: "public/data/daily-news.md"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions-bot@users.noreply.github.com"