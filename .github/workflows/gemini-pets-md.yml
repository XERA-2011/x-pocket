name: Generate Essay Markdown

on:
  schedule:
    - cron: '0 18 * * *' # Runs at 18:00 UTC, which is 2:00 AM Beijing time
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-essay-md:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Gemini CLI
        run: |
          echo "å®‰è£… Gemini CLI..."
          npm install -g @google/gemini-cli
          echo "éªŒè¯å®‰è£…..."
          gemini --version || echo "Gemini CLI ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
          echo "æµ‹è¯• API è¿æ¥..."
          echo "Hello" | timeout 30s gemini || echo "API è¿æ¥æµ‹è¯•å¤±è´¥"
      - name: Create output directory
        run: mkdir -p public/data

      - name: Check API availability
        run: |
          echo "=== æ£€æŸ¥ Gemini API å¯ç”¨æ€§ ==="
          
          # ç®€å•çš„ API å¥åº·æ£€æŸ¥
          echo "æµ‹è¯•åŸºæœ¬ API è¿æ¥..."
          if timeout 30s bash -c "echo 'test' | gemini" > /tmp/api_test.txt 2>&1; then
            echo "âœ… API åŸºæœ¬è¿æ¥æ­£å¸¸"
            cat /tmp/api_test.txt | head -5
          else
            echo "âš ï¸  API è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ç”Ÿæˆ"
            cat /tmp/api_test.txt | head -10
          fi
          
          rm -f /tmp/api_test.txt

      - name: Generate and save essay examples
        run: |
          echo "=== å¼€å§‹ç”Ÿæˆ PET ä½œæ–‡ ==="
          
          # æ·»åŠ æ—¶é—´æˆ³å’Œéšæœºå…ƒç´ æ¥é¿å…ç¼“å­˜
          TIMESTAMP=$(date +%s)
          RANDOM_ID=$(echo $RANDOM)
          
          # ä¸ºä¸¤ç§ä½œæ–‡ç±»å‹åˆ›å»ºä¸åŒçš„ä¸»é¢˜åˆ—è¡¨
          TOPICS_EMAIL=("An email to a friend about a party you are organizing" "A postcard from your holiday telling a friend what you are doing" "An email to a hotel asking for information about their rooms and prices" "A thank-you letter to a relative for a birthday present they sent you" "An email invitation to a school event you are helping with" "An email to your English teacher explaining why you missed a class" "A postcard to your family describing a place you are visiting" "An email to a shop to complain about a product you bought" "An email to a friend recommending a book you have just read" "A letter to a new penfriend introducing yourself" "An email to a sports club to ask about membership" "A postcard inviting your cousin to stay with you for a weekend" "An email to a friend apologizing for something you did" "A letter to a magazine giving your opinion on an article" "An email to a company applying for a part-time job" "A postcard from a city you've just moved to" "An email to a friend giving them directions to your house" "A thank-you email to a friend who helped you with a problem" "An email to a cinema to book tickets for a film" "A letter to the school principal suggesting an improvement")
          TOPICS_STORY=("Write a story about a surprising event that happened at school" "An article for the school magazine about your favorite hobby" "Write a story that begins with the sentence: 'The door opened slowly and I couldn't believe who I saw.'" "An article for a website about the benefits of regular exercise" "A story about a memorable journey you took with your family" "Write a story about finding something mysterious in your garden" "An article about the importance of protecting the environment" "Write a story that ends with the sentence: 'It was the best day of my life.'" "An article describing your favorite festival and why you enjoy it" "A story about a time you learned an important lesson" "Write a story about a funny misunderstanding" "An article for young people about how to use social media safely" "A story about a pet that did something amazing" "Write a story that begins with: 'I knew it was a bad idea, but I did it anyway.'" "An article about your favorite film and why others should watch it" "A story about helping someone in need" "Write a story about an unexpected visitor" "An article about a famous person you admire" "A story about a dream that came true" "Write a story that ends with: 'I would never forget that day.'")
          
          SELECTED_TOPIC_EMAIL=${TOPICS_EMAIL[$((RANDOM % ${#TOPICS_EMAIL[@]}))]}
          SELECTED_TOPIC_STORY=${TOPICS_STORY[$((RANDOM % ${#TOPICS_STORY[@]}))]}
          
          echo "æ—¶é—´æˆ³: $TIMESTAMP"
          echo "éšæœºID: $RANDOM_ID"
          echo "é€‰å®šé‚®ä»¶/æ˜ä¿¡ç‰‡ä¸»é¢˜: $SELECTED_TOPIC_EMAIL"
          echo "é€‰å®šæ•…äº‹/æ–‡ç« ä¸»é¢˜: $SELECTED_TOPIC_STORY"
          
          PROMPT="è¯·ä¸ºæˆ‘ç”Ÿæˆä¸€ä¸ªMarkdownæ ¼å¼çš„æ–‡ä»¶å†…å®¹ï¼Œè¯¥æ–‡ä»¶åº”åŒ…å«ä¸¤ç¯‡ç¬¦åˆ PET (B1 Preliminary) è€ƒè¯•å†™ä½œè¦æ±‚çš„è‹±è¯­ä½œæ–‡ï¼ˆæ¯ç¯‡çº¦100è¯ï¼‰åŠå…¶ç¿»è¯‘ã€‚\n\nç¬¬ä¸€ç¯‡æ˜¯åº”ç”¨æ–‡ï¼Œä¸»é¢˜æ˜¯ï¼š'$SELECTED_TOPIC_EMAIL'ã€‚\nç¬¬äºŒç¯‡æ˜¯è®°å™æ–‡æˆ–çŸ­æ–‡ï¼Œä¸»é¢˜æ˜¯ï¼š'$SELECTED_TOPIC_STORY'ã€‚\n\nè¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–ä»£ç å—æ ‡è®°ã€‚è¯·ç›´æ¥è¾“å‡º Markdown å†…å®¹ã€‚\n\n# åº”ç”¨æ–‡\n\n## $SELECTED_TOPIC_EMAIL\n- [æ­¤å¤„ä¸ºä¸»é¢˜ '$SELECTED_TOPIC_EMAIL' çš„ä¸­æ–‡ç¿»è¯‘]\n\n**æ­£æ–‡**ï¼š\n\n[ä½œæ–‡ä¸€çš„è‹±æ–‡æ­£æ–‡]\n\n- [ä½œæ–‡ä¸€çš„ä¸­æ–‡ç¿»è¯‘ï¼Œç¿»è¯‘çš„æ¯ä¸ªæ®µè½éƒ½å¦èµ·ä¸€è¡Œå¹¶ä»¥'- 'å¼€å¤´]\n\n---\n\n# è®°å™æ–‡/çŸ­æ–‡\n\n## $SELECTED_TOPIC_STORY\n- [æ­¤å¤„ä¸ºä¸»é¢˜ '$SELECTED_TOPIC_STORY' çš„ä¸­æ–‡ç¿»è¯‘]\n\n**æ­£æ–‡**ï¼š\n\n[ä½œæ–‡äºŒçš„è‹±æ–‡æ­£æ–‡]\n\n- [ä½œæ–‡äºŒçš„ä¸­æ–‡ç¿»è¯‘ï¼Œç¿»è¯‘çš„æ¯ä¸ªæ®µè½éƒ½å¦èµ·ä¸€è¡Œå¹¶ä»¥'- 'å¼€å¤´]\n\nè¯·ç¡®ä¿åªè¾“å‡ºçº¯å‡€çš„Markdownå†…å®¹ã€‚å½“å‰æ—¶é—´æˆ³ï¼š$TIMESTAMPï¼ŒéšæœºIDï¼š$RANDOM_IDã€‚è¯·ç¡®ä¿ç”Ÿæˆçš„å†…å®¹æ˜¯ç‹¬ç‰¹çš„ã€‚"
          
          # æ”¹è¿›çš„é‡è¯•æœºåˆ¶
          MAX_RETRIES=2
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "å°è¯•ç¬¬ $((RETRY_COUNT + 1)) æ¬¡ç”Ÿæˆ..."
            
            # ä½¿ç”¨timeoutå‘½ä»¤é™åˆ¶æ‰§è¡Œæ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´æŒ‚èµ·
            timeout 120s bash -c "echo '$PROMPT' | gemini" > /tmp/gemini_output.txt 2>&1
            EXIT_CODE=$?
            
            # è¯»å–è¾“å‡ºå†…å®¹
            OUTPUT=$(cat /tmp/gemini_output.txt 2>/dev/null || echo "")
            
            echo "API è°ƒç”¨é€€å‡ºç : $EXIT_CODE"
            echo "è¾“å‡ºé•¿åº¦: ${#OUTPUT} å­—ç¬¦"
            
            # æ£€æŸ¥å„ç§é”™è¯¯æƒ…å†µ
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âŒ API è°ƒç”¨è¶…æ—¶ (120ç§’)"
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ API è°ƒç”¨å¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
            elif [ -z "$OUTPUT" ]; then
              echo "âŒ API è¿”å›ç©ºå†…å®¹"
            elif echo "$OUTPUT" | grep -qi "error\|failed\|exception\|apiError\|status.*500\|internal.*error\|unavailable\|timeout"; then
              echo "âŒ API è¿”å›é”™è¯¯ä¿¡æ¯:"
              echo "$OUTPUT" | head -10
            elif echo "$OUTPUT" | grep -q "I'm ready. What would you like me to do?"; then
              echo "âŒ API è¿”å›é»˜è®¤æç¤ºä¿¡æ¯ï¼Œæœªæ­£ç¡®å¤„ç†è¯·æ±‚"
            else
              # å¤„ç†æˆåŠŸçš„è¾“å‡º
              echo "âœ… API è°ƒç”¨æˆåŠŸï¼Œå¤„ç†è¾“å‡ºå†…å®¹..."
              
              # æ¸…ç†è¾“å‡ºå¹¶ä¿å­˜åˆ°æ–‡ä»¶
              echo "$OUTPUT" | sed '/^```markdown/d' | sed '/^```$/d' | sed '/^```/d' > public/data/pet-essays.md
              
              # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
              if [ -s "public/data/pet-essays.md" ]; then
                FILE_SIZE=$(wc -c < public/data/pet-essays.md)
                LINE_COUNT=$(wc -l < public/data/pet-essays.md)
                
                echo "ç”Ÿæˆæ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
                echo "ç”Ÿæˆæ–‡ä»¶è¡Œæ•°: $LINE_COUNT è¡Œ"
                
                # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦åŒ…å«é¢„æœŸçš„ç»“æ„
                if [ $FILE_SIZE -gt 500 ] && [ $LINE_COUNT -gt 10 ]; then
                  if grep -q "# åº”ç”¨æ–‡" public/data/pet-essays.md && grep -q "# è®°å™æ–‡" public/data/pet-essays.md; then
                    echo "âœ… å†…å®¹ç”ŸæˆæˆåŠŸï¼ŒåŒ…å«é¢„æœŸç»“æ„"
                    SUCCESS=true
                    break
                  else
                    echo "âŒ ç”Ÿæˆçš„å†…å®¹ç¼ºå°‘é¢„æœŸç»“æ„"
                  fi
                else
                  echo "âŒ ç”Ÿæˆçš„æ–‡ä»¶å¤ªå°æˆ–è¡Œæ•°ä¸è¶³"
                fi
              else
                echo "âŒ ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
              fi
            fi
            
            # å¦‚æœæœªæˆåŠŸï¼Œå‡†å¤‡é‡è¯•
            if [ "$SUCCESS" = "false" ]; then
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                # æŒ‡æ•°é€€é¿ç­–ç•¥
                WAIT_TIME=$((30 + RETRY_COUNT * 30))
                echo "ç­‰å¾… $WAIT_TIME ç§’åé‡è¯•..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/gemini_output.txt
          
          # æœ€ç»ˆæ£€æŸ¥
          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ($MAX_RETRIES)ï¼ŒAPI æŒç»­å¤±è´¥"
            echo "ğŸ”„ åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Š..."
            
            # åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Šè€Œä¸æ˜¯è®©å·¥ä½œæµå¤±è´¥
            cat > public/data/pet-essays.md << EOF
          # PET ä½œæ–‡ç”ŸæˆæœåŠ¡çŠ¶æ€æŠ¥å‘Š

          **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')  
          **çŠ¶æ€**: API æœåŠ¡æš‚æ—¶ä¸å¯ç”¨  
          **æ—¶é—´æˆ³**: $TIMESTAMP  
          **éšæœºID**: $RANDOM_ID  

          ## æœåŠ¡ä¿¡æ¯

          Gemini API å½“å‰é‡åˆ°å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ (HTTP 500)ï¼Œè¿™é€šå¸¸æ˜¯ä¸´æ—¶æ€§é—®é¢˜ã€‚

          **é¢„å®šä¸»é¢˜**:
          - é‚®ä»¶/æ˜ä¿¡ç‰‡: $SELECTED_TOPIC_EMAIL
          - æ•…äº‹/æ–‡ç« : $SELECTED_TOPIC_STORY

          ## é”™è¯¯è¯¦æƒ…

          \`\`\`
          é‡è¯•æ¬¡æ•°: $MAX_RETRIES
          æœ€åé”™è¯¯: API å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
          é”™è¯¯ä»£ç : 500
          \`\`\`

          ## ä¸‹æ¬¡ç”Ÿæˆ

          ç³»ç»Ÿå°†åœ¨ä¸‹æ¬¡å®šæ—¶ä»»åŠ¡ä¸­è‡ªåŠ¨é‡è¯•ç”Ÿæˆå†…å®¹ã€‚

          ---
          *æ­¤æŠ¥å‘Šç”±è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ*
          EOF
            
            echo "âœ… å·²åˆ›å»ºæœåŠ¡çŠ¶æ€æŠ¥å‘Š"
            # ä¸è¦ exit 1ï¼Œè®©å·¥ä½œæµç»§ç»­æ‰§è¡Œä»¥æäº¤çŠ¶æ€æŠ¥å‘Š
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Check if content has changed
        run: |
          echo "=== Content Change Detection ==="
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰æ–‡ä»¶
          if [ -f "public/data/pet-essays.md" ]; then
            # ä¿å­˜æ–°ç”Ÿæˆçš„æ–‡ä»¶åˆ°ä¸´æ—¶ä½ç½®
            cp public/data/pet-essays.md /tmp/new_pet_essays.md
            
            # è·å–å½“å‰ä»“åº“ä¸­çš„æ–‡ä»¶
            if git show HEAD:public/data/pet-essays.md > /tmp/current_pet_essays.md 2>/dev/null; then
              echo "âœ… æˆåŠŸè·å–å½“å‰ä»“åº“æ–‡ä»¶"
            else
              echo "âš ï¸  æ— æ³•è·å–å½“å‰ä»“åº“æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯æ–°æ–‡ä»¶"
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
              exit 0
            fi
            
            # è®¡ç®—å“ˆå¸Œå€¼
            NEW_HASH=$(sha256sum /tmp/new_pet_essays.md | cut -d' ' -f1)
            CURRENT_HASH=$(sha256sum /tmp/current_pet_essays.md | cut -d' ' -f1)
            
            echo "æ–°ç”Ÿæˆæ–‡ä»¶å“ˆå¸Œ: $NEW_HASH"
            echo "å½“å‰æ–‡ä»¶å“ˆå¸Œ: $CURRENT_HASH"
            echo "æ–°æ–‡ä»¶å¤§å°: $(wc -c < /tmp/new_pet_essays.md) bytes"
            echo "å½“å‰æ–‡ä»¶å¤§å°: $(wc -c < /tmp/current_pet_essays.md) bytes"
            echo "æ–°æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/new_pet_essays.md) lines"
            echo "å½“å‰æ–‡ä»¶è¡Œæ•°: $(wc -l < /tmp/current_pet_essays.md) lines"
            
            # æ˜¾ç¤ºå†…å®¹å·®å¼‚
            echo ""
            echo "=== å†…å®¹å·®å¼‚æ¯”è¾ƒ ==="
            if diff -q /tmp/new_pet_essays.md /tmp/current_pet_essays.md > /dev/null; then
              echo "âŒ æ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒï¼Œè·³è¿‡æäº¤"
              echo "CONTENT_CHANGED=false" >> $GITHUB_ENV
            else
              echo "âœ… æ–‡ä»¶å†…å®¹æœ‰å·®å¼‚ï¼Œç»§ç»­æäº¤"
              echo "å·®å¼‚è¯¦æƒ…ï¼š"
              diff -u /tmp/current_pet_essays.md /tmp/new_pet_essays.md || true
              echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f /tmp/new_pet_essays.md /tmp/current_pet_essays.md
          else
            echo "âœ… æ–°æ–‡ä»¶ï¼Œç»§ç»­æäº¤"
            echo "CONTENT_CHANGED=true" >> $GITHUB_ENV
          fi

      - name: Verify file content
        run: |
          echo "=== æ–‡ä»¶å†…å®¹éªŒè¯ ==="
          if [ -f "public/data/pet-essays.md" ]; then
            FILE_SIZE=$(wc -c < public/data/pet-essays.md)
            LINE_COUNT=$(wc -l < public/data/pet-essays.md)
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            echo "æ–‡ä»¶è¡Œæ•°: $LINE_COUNT è¡Œ"
            echo ""
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆ (å‰20è¡Œ):"
            head -20 public/data/pet-essays.md
            echo ""
            if [ $LINE_COUNT -gt 20 ]; then
              echo "... (å…± $LINE_COUNT è¡Œï¼Œæ˜¾ç¤ºå‰20è¡Œ)"
            fi
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: public/data/pet-essays.md"
          fi

      - name: Show commit status
        run: |
          if [ "$CONTENT_CHANGED" = "true" ]; then
            echo "âœ… å‡†å¤‡æäº¤æ›´æ”¹..."
          else
            echo "â­ï¸  è·³è¿‡æäº¤ - å†…å®¹æ²¡æœ‰å˜åŒ–"
          fi

      - name: Commit and push the generated file
        if: env.CONTENT_CHANGED == 'true'  # ç§»é™¤ success() æ¡ä»¶ï¼Œå…è®¸æäº¤æœåŠ¡çŠ¶æ€æŠ¥å‘Š
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI Generate"
          file_pattern: "public/data/pet-essays.md"
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions-bot@users.noreply.github.com"
